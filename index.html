<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nutrition Comparison</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
  <link href="index.css" rel="stylesheet">
</head>
<body>

<div id="container">
  <h2>Compare Nutrition</h2>
  <div style="position: relative;">
    <input type="text" id="search" placeholder="Search foods...">
    <button onclick="submitObject()" class="button">Submit</button>
    <div id="suggestions" class="dropdown"></div>
  </div>
  <table id="results"></table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>

  class FoodItem {
    constructor(food) {
      this.food = food;
      this.element = document.createElement("div");
      this.element.classList.add("dropdown-item");
      this.element.textContent = food.description;
      this.element.addEventListener("click", () => {
        suggestions.style.display = "none";
        document.getElementById("search").value = food.description;
        document.getElementById("search").focus();
        suggestions.innerHTML = "";
      });
      this.text = food.description.toLowerCase();
      this.fields = food.description.split(",").length;
    }
  }

  let FOODS = [];
  fetch('data/food.csv')
    .then(response => response.text())
    .then(data => {
      Papa.parse(data, { header: true, delimiter: ',' }).data
        .forEach((food) => { if (food.description) FOODS.push(new FoodItem(food)); });
    });

  let NUTRIENTDATA;
  fetch('data/nutrient_data.csv')
    .then(response => response.text())
    .then(data => {
      NUTRIENTDATA = Papa.parse(data, { header: true, delimiter: ',' }).data;
      const results = document.getElementById("results");
      const headings = createElement("tr", results, "heading");
      createElement("td", headings);
      NUTRIENTDATA.forEach(nutrient => {
        if (nutrient.id) {
          const div = createElement("tr", results, nutrient.id);
          const text = createElement("td", div, null, ["header"]);
          text.innerHTML = nutrient.name;
        } else {
          createElement("tr", results);
        }
      });
      hideRows("1258", 6);
    });

  let NUTRIENTS;
  fetch('data/food_nutrient.csv')
    .then(response => response.text())
    .then(data => {
      NUTRIENTS = Papa.parse(data, { header: true, delimiter: ',' }).data;
    });

  let PORTION;
  fetch('data/food_portion.csv')
    .then(response => response.text())
    .then(data => {
      PORTION = Papa.parse(data, { header: true, delimiter: ',' }).data;
    });

  function createElement(type, parent, id = null, classes = []) {
    const element = document.createElement(type);
    if (id) element.id = id;
    classes.forEach(cls => element.classList.add(cls));
    parent.appendChild(element);
    return element;
  }

  function toggle(element, n) {
    for (let i = 0; i < n; i++) {
      element = element.nextSibling;
      element.style.display = element.style.display == "none" ? "" : "none";
    }
  }

  function hideRows(id, n) {
    let parent = document.getElementById(id);
    let button = createElement("div", parent.firstChild, null, ["toggle"]);
    button.innerHTML = "⏏";
    button.addEventListener("click", () => { toggle(parent, n); button.classList.toggle("flip") });
    toggle(parent, n);
  }

  function sortSuggestions(a, b, match) {
    if (a.text.startsWith(match) && !b.text.startsWith(match)) return -1;
    if (b.text.startsWith(match) && !a.text.startsWith(match)) return 1;
    if (a.fields != b.fields) return a.fields - b.fields;
    return a.text.localeCompare(b.text);
  }

  function showSuggestions(e) {
    const input = e.target.value.toLowerCase().split(" ");
    const suggestions = document.getElementById("suggestions");
    suggestions.innerHTML = "";
    suggestions.style.display = "block";
    
    FOODS
      .filter(food => input.every(word => food.text.includes(word)))
      .sort((a, b) => sortSuggestions(a, b, input[0]))
      .forEach(food => suggestions.appendChild(food.element));
  }

  function submitObject() {
    const search = document.getElementById("search").value.toLowerCase();
    const food = FOODS.find(food => food.text == search);
    if (food) {
      searchFood(food.food);
      document.getElementById("search").value = "";
    }
  }

  function addHeader(head, food) {
    const close = createElement("div", head, null, ["close"]);
    close.innerHTML = "×";
    close.addEventListener("click", (e) => {
      document.getElementById(head.id).remove();
      NUTRIENTDATA.forEach(nutrient => {
        if (nutrient.id) {
          highlightMax(nutrient.id);
          document.getElementById(`${head.id}-${nutrient.id}`).remove();
        }
      });
    });

    const label = createElement("p", head);
    label.innerHTML += food.description;

    const box = createElement("div", head, null, ["portion-input-box"]);
    const input = createElement("input", box, null, ["portion-input"]);
    const dropdown = createElement("div", box, null, ["dropdown"]);
    const button = createElement("button", box, null, ["button"]);
    input.type = "text";
    input.addEventListener("focus", () => dropdown.style.display = "block");
    input.addEventListener("focusout", () => dropdown.style.display = "none");
    input.addEventListener("input", filterDropdown);
    input.addEventListener("keydown", (e) => { if (e.key == "Enter") submitFood(); });
    input.placeholder = "Amount";

    function submitFood() {
      let value = parseFloat(input.value) || 100;
      input.value = "";
      NUTRIENTDATA.forEach(nutrient => {
        if (nutrient.id) addEntry(nutrient, head.id, food.fdc_id, value);
      });
    }

    function filterDropdown() {
      const value = input.value.toLowerCase();
      Array.from(dropdown.children).forEach(option => {
        option.style.display = option.textContent.toLowerCase().includes(value) ? "block" : "none";
      });
    }

    function addPortion(text) {
      const portion = createElement("div", dropdown, null, ["dropdown-item"]);
      portion.textContent = text;
      portion.addEventListener("mousedown", () => {
        input.value = "";
        NUTRIENTDATA.forEach(nutrient => {
          if (nutrient.id) addEntry(nutrient, head.id, food.fdc_id, parseFloat(text));
        });
      });
    }

    const calories = Math.round(1000000 / parseFloat(NUTRIENTS.find(nutrient => {return nutrient.fdc_id == food.fdc_id && nutrient.nutrient_id == "1008"}).amount)) / 100;
    addPortion("100g");
    addPortion(`${calories}g (100 calories)`);
    PORTION.forEach(item => {
      if (item.fdc_id == food.fdc_id)
        addPortion(`${item.gram_weight}g (${item.amount} ${item.modifier})`);
    });

    button.innerHTML = "Submit";
    button.addEventListener("click", submitFood);

  }

  function addEntry(nutrient, uuid, fdc_id, amt) {
    const data = NUTRIENTS.find(item => item.nutrient_id == nutrient.id && item.fdc_id == fdc_id);
    const bar = document.getElementById(`${uuid}-${nutrient.id}-bar`);
    const label = document.getElementById(`${uuid}-${nutrient.id}-label`);
    if (data) {
      let amount = (data.amount * amt);
      label.innerHTML = Math.round(amount) / 100 + nutrient.units;
      if (parseFloat(nutrient.dri) > 0) {
        let percent = Math.round(amount / parseFloat(nutrient.dri) * 100) / 100;
        bar.style.background = `linear-gradient(90deg, #ffdab7 ${percent}%, #eaeaea 0%`;
        label.innerHTML += ` ${percent}%`;
        highlightMax(nutrient.id);
      }
    } else {
      label.innerHTML = "";
    }

    if (parseFloat(nutrient.dri) <= 0)
      bar.style.background = "none";

  }

  function searchFood(food) {
    const heading = document.getElementById("heading");
    const uuid = Date.now();
    const header = createElement("td", heading, uuid);
    addHeader(header, food);
    NUTRIENTDATA.forEach(nutrient => {
      if (nutrient.id) {
        const objectDiv = document.getElementById(nutrient.id);
        const nutrientDiv = createElement("td", objectDiv, `${uuid}-${nutrient.id}`, ["nutrient"]);
        const bar = createElement("div", nutrientDiv, `${uuid}-${nutrient.id}-bar`, ["progress-bar", `${nutrient.id}-bar`]);
        const label = createElement("p", bar, `${uuid}-${nutrient.id}-label`, ["label", `${nutrient.id}-label`]);
        addEntry(nutrient, uuid, food.fdc_id, 100);
      }
    });
  }

  function highlightMax(id) {
    const labels = Array.from(document.getElementsByClassName(`${id}-label`));
    let max = labels.reduce((a, b) => ((parseFloat(b.textContent) > a) ? parseFloat(b.textContent) : a), 0);
    labels.forEach((elem) => {
      elem.parentNode.style.background = parseFloat(elem.textContent) == max ? 
        elem.parentNode.style.background.replace("(255, 218, 183)", "(255, 175, 110)") : 
        elem.parentNode.style.background.replace("(255, 175, 110)", "(255, 218, 183)");
    });
  }

  document.getElementById("search").addEventListener("input", showSuggestions);
  document.getElementById("search").addEventListener("keydown", (e) => { if (e.key == "Enter") submitObject(); });

</script>

</body>
</html>
